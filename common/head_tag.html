<script type="text/discourse-plugin" version="0.8.7">
    if (settings.custom_profile_link_debug_mode) console.debug("[Custom Profile Link] Settings dump follows",settings);
    const ids       = settings.custom_profile_link_user_field_ids.replace(/_/g,"").split(/\|/).map(Number);
    const labels    = settings.custom_profile_link_labels.split(/\|/);
    const prefixes  = settings.custom_profile_link_prefixes.split(/\|/);
    const orgs      = settings.custom_profile_link_orgs.split(/\|/);
    const parsedSettings = {"ids": ids, "labels": labels, "prefixes": prefixes /*, "orgs": {"labels": orgLabels, "name-ids": orgNames, "url-ids": orgUrls} */}
    if (settings.custom_profile_link_debug_mode) console.debug("[Custom Profile Link] Parsed settings dump follows",parsedSettings);
    api.registerConnectorClass('user-profile-primary', 'custom-profile-link', {
      setupComponent(args, component) {
        let links = [];
        if (!args.model.get('user_fields')) {
          console.warn(`[Custom Profile Link] User Card () missing "user_fields"! Raw user dump follows.`,args.model);
          component.set('customProfileLink', undefined);
        } else {
          for (let i=0;i<ids.length;i++) {
              if (!args.model.get('user_fields')[ids[i]] && settings.custom_profile_link_debug_mode) console.debug(`[Custom Profile Link] User field ${ids[i]} missing. user_fields dump follows.`,args.model.get("user_fields"));
              if (!!args.model.get('user_fields')[ids[i]]) links.push([args.model.get('user_fields')[ids[i]], labels[i], prefixes[i]]);
          }
          if (settings.custom_profile_link_debug_mode) console.debug("[Custom Profile Link] links built, dump:",links)
          component.set('customProfileLink', links);
        }
      }
    });

    api.registerConnectorClass('user-card-metadata', 'custom-profile-link', {
      setupComponent(args, component) {
        let links = [];
        if (!args.user.get('user_fields')) {
          console.warn(`[Custom Profile Link] User Profile () missing "user_fields"! Raw user dump follows.`,args.user);
          component.set('customProfileLink', undefined);
        } else {
          for (let i=0;i<ids.length;i++) {
              if (!args.user.get('user_fields')[ids[i]] && settings.custom_profile_link_debug_mode) console.debug(`[Custom Profile Link] User field ${ids[i]} missing. user_fields dump follows.`,args.user.get("user_fields"));
              if (!!args.user.get('user_fields')[ids[i]]) links.push([args.user.get('user_fields')[ids[i]], labels[i], prefixes[i]]);
          }
          if (settings.custom_profile_link_debug_mode) console.debug("[Custom Profile Link] links built, dump:",links)
          component.set('customProfileLink', links);
        }
      }
    });
    if (settings.custom_profile_link_debug_mode) console.debug("[Custom Profile Link] Script loaded");
</script>
